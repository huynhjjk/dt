<!DOCTYPE html>
<html lang="en" ng-app="DT-SERVER">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DT-SERVER</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  </head>
  <body ng-controller="ServerController">
    <div class="container">
      <button class="btn btn-primary btn-lg" ng-click="removeFirebaseStocks()">Remove</button>
      <pre>
        {{firebaseStocks.length}} Results
        {{firebaseStocks | json}}
      </pre>
    </div>
    <script src="all-stock-symbols-jan-2015"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.2.2/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/angularfire/1.0.0/angularfire.min.js"></script>
    <script>
      var app = angular.module('DT-SERVER', ['firebase']);
      app.controller('ServerController', ['$scope', '$http', '$q', '$interval', '$firebaseArray', function($scope, $http, $q, $interval, $firebaseArray) { 
           $scope.firebaseStocksRef = new Firebase("https://dt-app.firebaseio.com/").child("stocks");
           $scope.firebaseStocks = $firebaseArray($scope.firebaseStocksRef);
            $scope.removeFirebaseStocks = function() {
              $scope.firebaseStocksRef.remove();           
            }

          // Site domain: localhost
          // Consumer key: e3607fbbbc59dabc
          // Consumer secret: 082e6fc86fb4e39c40797539613f5f2ceac0ece5
          // Request token URL: https://api.stocktwits.com/api/2/oauth/token
          // Authorize URL: https://api.stocktwits.com/api/2/oauth/authorize
          // DeAuthorization URL: None
          // Use link below to get token
          // https://api.stocktwits.com/api/2/oauth/authorize?client_id=e3607fbbbc59dabc&response_type=token&redirect_uri=http://localhost:8888/dt/#trends&scope=read,watch_lists,publish_messages,publish_watch_lists,follow_users,follow_stocks

            var tokens = {
              stockTwits: 'f7df9f117b9aaf79bd77d126ac4d443df93a2846'
            }

            // StockTwits Trending Tickers
            var getTrendingStockTwitsTickers = function() {
              return $q(function(resolve, reject) {
                //https://api.stocktwits.com/api/2/trending/symbols.json?access_token=f7df9f117b9aaf79bd77d126ac4d443df93a2846
                var config = {
                    url: 'https://api.stocktwits.com/api/2/trending/symbols.json',
                    method: 'GET',
                    params: {
                        access_token: tokens.stockTwits
                    }
                };
                $http(config).
                  success(function(data, status, headers, config) {
                    var symbols = [];
                    for (var i = 0; i < data.symbols.length; i++) {
                      symbols.push(data.symbols[i].symbol);
                    }
                    resolve(symbols);
                  }).
                  error(function(data, status, headers, config) {
                    alert('Error', status);
                    console.log(data);
                  });
              });
            }

            var getAllStaticSymbols = function() {
              var symbols = [];
              for (var i = 0; i < allSymbols.length; i++) {
                symbols.push(allSymbols[i].Symbol);
              }
              return symbols;
            }

            // Google and Yahoo Finance Stock Mash Up
            var getStocks = function(symbols){

                var googleFinanceUrl = 'http://finance.google.com/finance/info?client=ig&q=' + symbols.join();
                var yahooFinanceUrl = 'https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%20in%20(%27' + symbols.join() + '%27)%0A%09%09&format=json&env=http%3A%2F%2Fdatatables.org%2Falltables.env&callback=';

                var urls = [];
                urls.push(googleFinanceUrl);
                urls.push(yahooFinanceUrl);

                var promises = [];

                for (var i = 0; i < urls.length; i++) {
                  promises.push($http.get(urls[i]));
                }

                return $q.all(promises);
            }

            var addStocksToFirebase = function(data) {
              var googleFinanceStocks = JSON.parse(data[0].data.substring(3, data[0].data.length));
              var yahooFinanceStocks = data[1].data.query.results.quote;
              for (var j = 0; j < googleFinanceStocks.length; j++) {
                var stock = {};
                // Google Finance
                stock.symbol = googleFinanceStocks[j].t || 0;
                stock.current = parseFloat(googleFinanceStocks[j].l) || 0;
                stock.changePrice = parseFloat(googleFinanceStocks[j].c) || 0;
                stock.changePercent = parseFloat(googleFinanceStocks[j].cp) || 0;
                stock.lastPurchase = new Date(googleFinanceStocks[j].lt_dts) || 0;
                stock.dividend = parseFloat(googleFinanceStocks[j].div) || 0;
                if ($scope.trendingStocks) {
                  stock.isTrending = ($scope.trendingStocks.indexOf(googleFinanceStocks[j].t) != -1) ? true:false;
                  stock.trendingRank = ($scope.trendingStocks.indexOf(googleFinanceStocks[j].t) != -1) ? $scope.trendingStocks.indexOf(googleFinanceStocks[j].t) + 1: 0;
                }
                // Yahoo Finance
                stock.name = yahooFinanceStocks[j].Name || 0;
                stock.averageDailyVolume = parseFloat(yahooFinanceStocks[j].AverageDailyVolume) || 0;
                stock.open = parseFloat(yahooFinanceStocks[j].Open) || 0;
                stock.close = parseFloat(yahooFinanceStocks[j].PreviousClose) || 0;
                stock.daysHigh = parseFloat(yahooFinanceStocks[j].DaysHigh) || 0;
                stock.daysLow = parseFloat(yahooFinanceStocks[j].DaysLow) || 0;
                stock.yearHigh = parseFloat(yahooFinanceStocks[j].YearHigh) || 0;
                stock.yearLow = parseFloat(yahooFinanceStocks[j].YearLow) || 0;
                stock.estimateCurrentYear = parseFloat(yahooFinanceStocks[j].EPSEstimateCurrentYear) || 0;
                stock.estimateNextQuarter = parseFloat(yahooFinanceStocks[j].EPSEstimateNextQuarter) || 0;
                stock.estimateNextYear = parseFloat(yahooFinanceStocks[j].EPSEstimateNextYear) || 0;
                stock.fiftyDayMovingAverage = parseFloat(yahooFinanceStocks[j].FiftydayMovingAverage) || 0;

                $scope.firebaseStocks.$add(stock);
              }
            }

            var getTrendingStocksData = function(symbols) {
                var symbolsPerCall = 116;
                var originalSymbolSize = angular.copy(symbols.length);      
                var iterate = Math.floor(originalSymbolSize / symbolsPerCall);

                for (var i = 0; i < iterate; i++) {
                  var sendToPromise = symbols.splice(0, symbolsPerCall);
                  getStocks(sendToPromise).then(function(data) {
                    addStocksToFirebase(data);
                  });
                  console.log('Making Call');
                }
                getStocks(symbols).then(function(data) {
                  addStocksToFirebase(data);
                  console.log('Making Last Call');
                });
            }

            /* Get Trending Stock Twits Stocks */
            // getTrendingStockTwitsTickers().then(function(trendingStocks) {
            //   $scope.trendingStocks = trendingStocks;
            //   $scope.symbols = trendingStocks;
            //   getTrendingStocksData($scope.symbols);
            // });

            /* Get All Stocks */
            // var symbols = getAllStaticSymbols();
            // getTrendingStocksData(symbols);

            // $scope.firebaseStocks.$loaded()
            //   .then(function(data) {
            //     // var symbols = [];
            //     // for (var i = 0; i < data.length; i++) {
            //     //   symbols.push(data[i].symbol);
            //     // }
            //     // var newStocksData = ?
            //     // for (var i = 0; i < newStocksData.length; j++) {
            //     //   $scope.firebaseStocks.update(newStocksData[i]);
            //     // }

            //     console.log($scope.firebaseStocks[0]);
            //     var keyReference = new Firebase("https://dt-app.firebaseio.com/").child("stocks").child("-JkkWWcJ02T4iNtHvC-E");
            //     //for each symbol object in new data
            //     //for each symbol in old data
            //     //compare matching old and new data
            //     //if both are the same company, then update()
            //     //switch case for each key to see which ones stay the same

              
            //     console.log(keyReference.update({ averageDailyVolume: 999}));
            //     // $scope.firebaseStocks.$save(i);                               
            //     console.log(data);
            //   })
            //   .catch(function(error) {
            //     console.error("Error:", error);
            //   });

            /* 20 Second Intervals */
            // $scope.firebaseStocks.$loaded()
            //   .then(function(data) {
                // var symbols = [];
                // for (var i = 0; i < data.length; i++) {
                //   symbols.push(data[i].symbol);
                // }                
                // for (var j = 0; j < data.length; j++) {                                    
                // }
                // $interval(function() {
                //   $scope.firebaseStocks
                //   getTrendingStocksData($scope.symbols);
                //   console.log('running');
                // }, 25000);
              // })
              // .catch(function(error) {
              //   console.error("Error:", error);
              // });

      }]);
    </script>
  </body>
</html>